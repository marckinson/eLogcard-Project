'use strict';

let session = require('express-session');
let fileExtension = require('file-extension');
let publicContentExtension=["js","css"];
let isPublicContent =function(req){
	let isPublicExtension = publicContentExtension.includes(fileExtension(req.originalUrl));
	if(!isPublicExtension){
		let isPublicUrl=(req.originalUrl=="/login" || req.originalUrl=="/registration" );
		return isPublicUrl;
	}else{
		return true;
	}
};
let sessionManagement=function(app){
	app.use(session({secret:'yoursecret', cookie:{maxAge:3600000},resave:false,saveUninitialized:false}));
	return  function(req, res, next) {
		//let isPublicContent=req.originalUrl.startsWith("/webContent/public/vendor");
		//console.log(req.originalUrl+" "+isPublicContent(req));
		let doNext=true;
		//Contenu publique ou login
		if(!isPublicContent(req)){
			//on recupere la session utilisateur
			let sess = req.session;
			if(sess.username==null){
				res.redirect(302,"/login");
				doNext=false;
			}
		}
		
		if(doNext){
			next();
		}
	}
};


module.exports = sessionManagement;
