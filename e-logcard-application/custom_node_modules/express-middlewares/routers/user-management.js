'use strict';

let express = require('express');
let router = express.Router();
let config=require('config');
let hfcUtil=require("../../utils/hfcUtil.js")
const nodeUtil = require('util');
let userManager=require("../../database/user-manager.js");
let tokenManager=require("../security/token-manager.js")

function init(){
	console.log("Initialisation de la base de donnees des users");
	return new Promise(function(resolve, reject) {
		//var usersCollection = mongoDb.database.collection("users");
		let adminUser=config.get("admin");
		userManager.findUserByLogin(adminUser.username,function(user){
			if(user==null){
				userManager.createUser(adminUser.username,adminUser.password,adminUser.role,function(user){
					resolve();
				});
			}
			else{
				console.log("L utilisateur admin existe deja");
				resolve();
			}
		
		});
    });
}


router.post("/login",function(req, res, next) {
	console.log("login UserName " + req.body.username);
	userManager.checkPassword(req.body.username,req.body.password,function(isOk){
		if(isOk){
			res.status(200).type('text/plain').send(tokenManager.getToken(req.body.username));
		}
		else{
			res.status(401).send("Bad Credentials");
		}
	
	});
});

router.post("/registration",function(req, res, next) {
	var username=req.body.username;
	var role=req.body.role;
	console.log("Registration of UserName " + username);
	userManager.findUserByLogin(username,function(user){
		if(user!=null){
			res.status(400).send("User "+req.body.username+" already exists");
			return ;
		}
		//on enroll les utilisateurs puis on les cree
		hfcUtil.enrollUser(username,role).then(function(enrolledUser){
			userManager.createUser(username,req.body.password,role,function(user){
				console.log("l utilisateur  bien  ajoute");	
				res.status(200).type('text/plain').send(tokenManager.getToken(username));
			});
		});
		
	});
});

router.get("/user/connectedUser",function(req,res,next){
	let user=req.user.username;
	res.status(200).send({"user":user});
});


router.get("/roles",function(req,res,next){
	let roles = [
			{"label": "Auditor_authority", "value": "Auditor authorit"},
            {"label": "AH_admin", "value": "AH admin"},
            {"label": "Supplier", "value": "Supplier"},
            {"label": "Manufacturer", "value": "Manufacturer"},
            {"label": "Customer", "value": "Customer"},
            {"label": "Maintenance_user", "value": "Maintenance user"} 
			]
	res.status(200).send(roles);
});


module.exports ={};
module.exports.router = router;
module.exports.init=init;