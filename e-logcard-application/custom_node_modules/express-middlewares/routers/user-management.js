'use strict';

let express = require('express');
let router = express.Router();
let config=require('config');
let hfcUtil=require("../../utils/hfcUtil.js")
const nodeUtil = require('util');
let userManager=require("../../database/user-manager.js");
let tokenManager=require("../security/token-manager.js")

function init(){
	console.log("Initialisation de la base de donnees des users");
	return new Promise(function(resolve, reject) {
		//var usersCollection = mongoDb.database.collection("users");
		let adminUser=config.get("admin");
		userManager.findUserByLogin(adminUser.username,function(user){
			if(user==null){
				userManager.createUser(adminUser.username,adminUser.password,adminUser.role,function(user){
					resolve();
				});
			}
			else{
				console.log("L utilisateur admin existe deja");
				resolve();
			}
		
		});
    });
}
router.post("/login",function(req, res, next) {
	console.log("login UserName " + req.body.username);
	userManager.checkPassword(req.body.username,req.body.password,function(user){
		if(!user){
			res.status(401).send("Bad Credentials");
		}
		else{
			res.status(200).type('application/json').send({"username":user.username,"role":user.role,"token":tokenManager.getToken(req.body.username)});
		}
		
	});
});
router.post("/registration",function(req, res, next) {
	var username=req.body.username;
	var role=req.body.role;
	console.log("Registration of UserName " + username);
	userManager.findUserByLogin(username,function(user){
		if(user!=null){
			res.status(400).send("User "+req.body.username+" already exists");
			return ;
		}
		//on enroll les utilisateurs puis on les cree
		hfcUtil.enrollUser(username,role).then(function(enrolledUser){
			userManager.createUser(username,req.body.password,role,function(user){
				console.log("l utilisateur  bien  ajoute");	
				res.status(200).type('text/plain').send(tokenManager.getToken(username));
			});
		});
		
	});
});
router.get("/user/connectedUser",function(req,res,next){
	let user=req.user.username;
	res.status(200).send({"user":user});
});


router.get("/roles",function(req,res,next){
	let roles = [
			{"label": "Auditor authority", "value": "Auditor_authority"},
            {"label": "AH admin", "value": "AH_admin"},
            {"label": "Supplier", "value": "supplier"},
            {"label": "Manufacturer", "value": "manufacturer"},
            {"label": "customer", "value": "customer"},
            {"label": "Maintenance user", "value": "maintenance_user"} 
			]
	res.status(200).send(roles);
});
/**
*Recuperation des utilisateurs du systeme
*
*
**/
router.get("/users",function(req,res,next){
	console.log("Recuperation de tous les utilisateurs du systeme");
	userManager.findAll(function(results){
	let users=[];
		for(let i=0;i<results.length;i++){
			let user=results[i];
			delete user.password;
			if(user.role!="admin"){
				users.push(user);
			}
		}
		res.status(200).send(users);
	});
});

module.exports ={};
module.exports.router = router;
module.exports.init=init;