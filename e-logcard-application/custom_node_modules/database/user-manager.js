let mongoDb=require("./mongo.js");

exports.findUserByLogin=function(username,callback){
	let usersCollection = mongoDb.database.collection("users");
	usersCollection.find({"username":username}).toArray(function(error,results){
		console.log("Recherche de l utilisateur "+username+" par login");
		if(error){
			throw error;
		}
		else if(results.length>1){
			throw "more than one user found for "+username;
		}
		else{
			return callback(results.length==0?null:results[0]);
		}
		
	});
};
exports.findAll=function(callback){
	let usersCollection = mongoDb.database.collection("users");
	usersCollection.find().toArray(function(error,results){
		console.log("Recherche de tous les utilisateurs");
		if(error){
			throw error;
		}
		else{
			return callback(results);
		}
		
	});
};
exports.createUser=function(username,password,role,callback){

	let user={"username":username,"password":password,"role":role};
	let usersCollection = mongoDb.database.collection("users");
	usersCollection.insert(user, null, function (error, results) {
		if (error) throw error;
		console.log("l utilisateur "+username+" a ete bien cree");    
		callback(user);
	});	
};

exports.checkPassword=function(username,password,callback){
	let user={"username":username,"password":password};
	let usersCollection = mongoDb.database.collection("users");
	usersCollection.find(user).toArray(function(error,results){
		console.log("Recherche de l utilisateur "+username+" par login");
		if(error){
			throw error;
		}
		else if(results.length>1){
			throw "more than one user found for "+username;
		}
		else if(results.length==0){
			return callback(false);
		}
		else{
			let retour={"username":username,"role":results[0].role};
			return callback(retour);
		}
		
	});
};